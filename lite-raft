#!/bin/dash

#Copyright (c) 2014 Luigi Tarenga <luigi.tarenga@gmail.com>
#Distributed under the terms of a MIT license.

set -e

#export sshopt="-o ConnectTimeout=1 -o StrictHostKeyChecking=no"
cd $(dirname $0)

case "$1" in
first-boot)
   if [ -f temp/master_lock ] ; then
      if ! flock -e -w 0 temp/master_lock true ; then
         echo temp/master_lock is locked. cannot initialize state-machine.
         exit 1
      fi
   fi
   echo first-boot
   rm -rf   state state-machine-log   state-machine-data state-machine-snapshot /dev/shm/lite-raft/temp
   mkdir -p state state-machine-log/0 state-machine-data state-machine-snapshot /dev/shm/lite-raft/temp
   touch state-machine-log/0/0
   echo 0  > state/current_term
   echo 0  > state/last_log_index
   echo "" > state/voted_for
   ./lite-raft-server > message-log/lite-raft-server.log &
;;
start)
   if [ -f temp/master_lock ] ; then
      if ! flock -e -w 0 temp/master_lock true ; then
         echo temp/master_lock is locked. server already started.
         exit 1
      fi
   fi
   ./lite-raft-server > message-log/lite-raft-server.log &
;;
stop)
   echo stop
   pkill -f "/bin/dash ./lite-raft-server"
;;
esac
